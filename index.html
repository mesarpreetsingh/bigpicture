<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BigPicture ‚Äî Stitch Photos & Videos into Panoramas</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,400;0,600;0,700;0,800;1,400;1,700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #fffdf9;
  --surface: #fff8f0;
  --surface2: #fff3e6;
  --orange: #ff6b35;
  --orange-light: #ff8c5a;
  --orange-pale: #fff0e8;
  --yellow: #ffc947;
  --green: #38c172;
  --red: #e3342f;
  --ink: #2d2416;
  --ink2: #6b5c47;
  --muted: #a89880;
  --border: #ede3d6;
  --shadow: 0 4px 24px rgba(255,107,53,0.10);
  --shadow-lg: 0 12px 48px rgba(255,107,53,0.15);
  --radius: 20px;
  --radius-sm: 12px;
}

html { scroll-behavior: smooth; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ BLOBS ‚îÄ‚îÄ */
.blob {
  position: fixed;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.18;
  pointer-events: none;
  z-index: 0;
  animation: blobFloat 8s ease-in-out infinite alternate;
}
.blob1 { width: 500px; height: 500px; background: #ff6b35; top: -150px; right: -100px; animation-delay: 0s; }
.blob2 { width: 400px; height: 400px; background: #ffc947; bottom: -100px; left: -100px; animation-delay: 3s; }
.blob3 { width: 300px; height: 300px; background: #ff8c5a; top: 40%; left: 30%; animation-delay: 6s; }

@keyframes blobFloat {
  from { transform: translate(0, 0) scale(1); }
  to   { transform: translate(30px, 20px) scale(1.05); }
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  position: relative; z-index: 10;
  padding: 1.5rem 3rem;
  display: flex; justify-content: space-between; align-items: center;
  animation: fadeDown 0.6s ease both;
}

.logo {
  display: flex; align-items: center; gap: 0.6rem;
  font-family: 'Lora', serif;
  font-size: 1.6rem; font-weight: 600;
  color: var(--ink);
  text-decoration: none;
}

.logo-icon {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--orange), var(--yellow));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
  box-shadow: 0 4px 12px rgba(255,107,53,0.35);
}

.nav-pill {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 100px;
  padding: 0.5rem 1.25rem;
  font-size: 0.8rem; font-weight: 700;
  color: var(--orange);
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero {
  position: relative; z-index: 10;
  text-align: center;
  padding: 4rem 2rem 3rem;
  animation: fadeUp 0.7s 0.1s ease both;
}

.hero-eyebrow {
  display: inline-flex; align-items: center; gap: 0.4rem;
  background: var(--orange-pale);
  border: 1.5px solid #ffd4be;
  border-radius: 100px;
  padding: 0.4rem 1rem;
  font-size: 0.8rem; font-weight: 700;
  color: var(--orange);
  margin-bottom: 1.5rem;
  animation: popIn 0.5s 0.3s ease both;
}

.hero h1 {
  font-family: 'Lora', serif;
  font-size: clamp(2.5rem, 7vw, 5rem);
  line-height: 1.1;
  letter-spacing: -0.02em;
  color: var(--ink);
  margin-bottom: 1.2rem;
}

.hero h1 span {
  background: linear-gradient(135deg, var(--orange), var(--yellow));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero p {
  font-size: 1.15rem;
  color: var(--ink2);
  max-width: 520px;
  margin: 0 auto 2.5rem;
  line-height: 1.7;
  font-weight: 400;
}

/* ‚îÄ‚îÄ FORMAT PILLS ‚îÄ‚îÄ */
.format-pills {
  display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem;
  margin-bottom: 3rem;
  animation: fadeUp 0.7s 0.4s ease both;
}

.pill {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 100px;
  padding: 0.35rem 0.85rem;
  font-size: 0.75rem; font-weight: 700;
  color: var(--ink2);
}

.pill.video {
  background: #fff3e6;
  border-color: #ffd4a8;
  color: var(--orange);
}

/* ‚îÄ‚îÄ MAIN APP CARD ‚îÄ‚îÄ */
.app-wrap {
  position: relative; z-index: 10;
  max-width: 820px;
  margin: 0 auto;
  padding: 0 1.5rem 6rem;
  animation: fadeUp 0.8s 0.2s ease both;
}

.card {
  background: #fff;
  border: 2px solid var(--border);
  border-radius: 28px;
  box-shadow: var(--shadow-lg);
  overflow: hidden;
}

/* ‚îÄ‚îÄ MODE TABS ‚îÄ‚îÄ */
.mode-tabs {
  display: grid; grid-template-columns: 1fr 1fr;
  border-bottom: 2px solid var(--border);
}

.mode-tab {
  padding: 1.25rem;
  text-align: center;
  cursor: pointer;
  font-weight: 700; font-size: 0.95rem;
  color: var(--muted);
  background: var(--surface);
  transition: all 0.25s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  border: none; font-family: 'Nunito', sans-serif;
}

.mode-tab:first-child { border-right: 2px solid var(--border); }

.mode-tab.active {
  background: #fff;
  color: var(--orange);
}

.mode-tab .tab-icon {
  width: 28px; height: 28px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
  background: var(--border);
  transition: background 0.25s;
}

.mode-tab.active .tab-icon {
  background: var(--orange-pale);
}

/* ‚îÄ‚îÄ UPLOAD PANEL ‚îÄ‚îÄ */
.panel { display: none; }
.panel.active { display: block; }

/* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
.drop-zone {
  margin: 2rem;
  border: 2.5px dashed var(--border);
  border-radius: var(--radius);
  padding: 3rem 2rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: var(--surface);
  position: relative;
  overflow: hidden;
}

.drop-zone:hover, .drop-zone.dragover {
  border-color: var(--orange);
  background: var(--orange-pale);
  transform: scale(1.01);
}

.drop-zone input { display: none; }

.drop-icon {
  width: 72px; height: 72px;
  margin: 0 auto 1.2rem;
  background: linear-gradient(135deg, var(--orange), var(--yellow));
  border-radius: 20px;
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem;
  box-shadow: 0 8px 24px rgba(255,107,53,0.3);
  transition: transform 0.3s;
}

.drop-zone:hover .drop-icon { transform: translateY(-4px) rotate(-3deg); }

.drop-title {
  font-family: 'Lora', serif;
  font-size: 1.3rem; font-weight: 600;
  color: var(--ink);
  margin-bottom: 0.4rem;
}

.drop-sub { font-size: 0.875rem; color: var(--muted); font-weight: 600; }

/* ‚îÄ‚îÄ VIDEO OPTIONS ‚îÄ‚îÄ */
.video-options {
  margin: 0 2rem 1rem;
  padding: 1.25rem 1.5rem;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
}

.video-options label {
  font-size: 0.85rem; font-weight: 700; color: var(--ink2);
  display: block; margin-bottom: 0.75rem;
}

.slider-wrap {
  display: flex; align-items: center; gap: 1rem;
}

.slider-wrap input[type=range] {
  flex: 1;
  -webkit-appearance: none;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  outline: none;
}

.slider-wrap input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px; height: 20px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--orange), var(--yellow));
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(255,107,53,0.4);
}

.slider-val {
  font-weight: 800; font-size: 0.9rem;
  color: var(--orange);
  min-width: 80px; text-align: right;
}

/* ‚îÄ‚îÄ PREVIEW THUMBNAILS ‚îÄ‚îÄ */
.thumbs-wrap {
  padding: 0 2rem 1.5rem;
  display: none;
}

.thumbs-wrap.visible { display: block; }

.thumbs-label {
  font-size: 0.75rem; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--muted); margin-bottom: 0.75rem;
}

.thumbs-grid {
  display: flex; gap: 0.6rem; flex-wrap: wrap;
}

.thumb {
  width: 72px; height: 54px;
  border-radius: 10px;
  object-fit: cover;
  border: 2px solid var(--border);
  animation: popIn 0.3s ease both;
  transition: transform 0.2s;
}
.thumb:hover { transform: scale(1.08); }

.thumb-more {
  width: 72px; height: 54px;
  border-radius: 10px;
  background: var(--surface2);
  border: 2px dashed var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem; font-weight: 800; color: var(--muted);
}

/* ‚îÄ‚îÄ BOTTOM BAR ‚îÄ‚îÄ */
.bottom-bar {
  padding: 1.5rem 2rem;
  border-top: 2px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  gap: 1rem; flex-wrap: wrap;
  background: var(--surface);
}

.file-badge {
  display: flex; align-items: center; gap: 0.5rem;
  font-size: 0.875rem; font-weight: 700; color: var(--ink2);
}

.file-badge .count {
  background: linear-gradient(135deg, var(--orange), var(--yellow));
  color: white;
  border-radius: 100px;
  padding: 0.2rem 0.65rem;
  font-size: 0.8rem; font-weight: 800;
}

.btn-row { display: flex; gap: 0.75rem; align-items: center; }

.btn {
  font-family: 'Nunito', sans-serif;
  font-size: 0.9rem; font-weight: 800;
  padding: 0.75rem 2rem;
  border-radius: 100px; border: none;
  cursor: pointer; transition: all 0.25s;
  display: inline-flex; align-items: center; gap: 0.4rem;
  text-decoration: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--orange), var(--orange-light));
  color: white;
  box-shadow: 0 4px 16px rgba(255,107,53,0.35);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(255,107,53,0.45);
}

.btn-primary:disabled {
  background: var(--border);
  color: var(--muted);
  box-shadow: none;
  cursor: not-allowed;
}

.btn-ghost {
  background: white;
  color: var(--ink2);
  border: 2px solid var(--border);
  font-size: 0.8rem;
  padding: 0.6rem 1.25rem;
}

.btn-ghost:hover { border-color: var(--orange); color: var(--orange); }

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress-panel {
  padding: 2rem;
  border-top: 2px solid var(--border);
  display: none;
}
.progress-panel.visible { display: block; animation: fadeUp 0.4s ease both; }

.steps {
  display: flex; flex-direction: column; gap: 0.75rem;
  margin-bottom: 1.5rem;
}

.step {
  display: flex; align-items: center; gap: 1rem;
  padding: 0.85rem 1.25rem;
  border-radius: var(--radius-sm);
  border: 2px solid var(--border);
  background: var(--surface);
  transition: all 0.4s;
  font-weight: 700; font-size: 0.9rem;
  color: var(--muted);
}

.step.active {
  border-color: var(--orange);
  background: var(--orange-pale);
  color: var(--orange);
}

.step.done {
  border-color: #c6f0d5;
  background: #f0fdf5;
  color: var(--green);
}

.step-icon {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
  background: var(--border);
  flex-shrink: 0;
  transition: all 0.4s;
}

.step.active .step-icon { background: var(--orange); }
.step.done .step-icon { background: var(--green); }

.step-text { flex: 1; }
.step-detail { font-size: 0.75rem; font-weight: 600; opacity: 0.7; margin-top: 0.1rem; }

/* ‚îÄ‚îÄ BIG PROGRESS BAR ‚îÄ‚îÄ */
.big-progress {
  background: var(--border);
  border-radius: 100px;
  height: 10px;
  overflow: hidden;
  margin-bottom: 0.75rem;
}

.big-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--orange), var(--yellow));
  border-radius: 100px;
  width: 0%;
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.big-progress-fill::after {
  content: '';
  position: absolute; right: 0; top: 0;
  width: 60px; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5));
  animation: shimmer 1.5s infinite;
}

.progress-info {
  display: flex; justify-content: space-between;
  font-size: 0.82rem; font-weight: 700; color: var(--ink2);
}

.progress-pct {
  font-family: 'Lora', serif;
  font-size: 1.8rem; font-weight: 600;
  color: var(--orange);
  text-align: center;
  margin-bottom: 1rem;
}

/* ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ */
.result-panel {
  padding: 2rem;
  border-top: 2px solid var(--border);
  display: none;
}
.result-panel.visible { display: block; animation: fadeUp 0.6s ease both; }

.result-header {
  display: flex; align-items: center; gap: 0.75rem;
  margin-bottom: 1.5rem;
}

.result-badge {
  background: #f0fdf5;
  border: 2px solid #c6f0d5;
  border-radius: 100px;
  padding: 0.4rem 1rem;
  font-size: 0.8rem; font-weight: 800;
  color: var(--green);
  display: flex; align-items: center; gap: 0.4rem;
}

.result-title {
  font-family: 'Lora', serif;
  font-size: 1.2rem; font-weight: 600;
  color: var(--ink);
}

.result-img-wrap {
  border-radius: var(--radius);
  overflow: hidden;
  border: 2px solid var(--border);
  background: var(--surface);
  margin-bottom: 1.5rem;
  max-height: 480px;
  display: flex; align-items: center; justify-content: center;
}

.result-img-wrap img {
  width: 100%; object-fit: contain;
  display: block; max-height: 480px;
}

.result-actions { display: flex; gap: 1rem; flex-wrap: wrap; }

/* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
.error-box {
  margin: 0 2rem 1.5rem;
  padding: 1rem 1.25rem;
  background: #fff5f5;
  border: 2px solid #fecaca;
  border-radius: var(--radius-sm);
  color: var(--red);
  font-size: 0.875rem; font-weight: 700;
  display: none;
  animation: fadeUp 0.3s ease both;
}
.error-box.visible { display: flex; align-items: flex-start; gap: 0.5rem; }

/* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2.5px solid rgba(255,255,255,0.35);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

.spin-orange {
  border-color: rgba(255,107,53,0.2);
  border-top-color: var(--orange);
}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
footer {
  position: relative; z-index: 10;
  text-align: center;
  padding: 2rem;
  font-size: 0.82rem; font-weight: 600;
  color: var(--muted);
  border-top: 2px solid var(--border);
}

footer a { color: var(--orange); text-decoration: none; }

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeDown { from { opacity:0; transform:translateY(-14px); } to { opacity:1; transform:translateY(0); } }
@keyframes fadeUp   { from { opacity:0; transform:translateY(18px);  } to { opacity:1; transform:translateY(0); } }
@keyframes popIn    { from { opacity:0; transform:scale(0.8); }        to { opacity:1; transform:scale(1); } }
@keyframes spin     { to { transform: rotate(360deg); } }
@keyframes shimmer  { from{opacity:0} 50%{opacity:1} to{opacity:0} }

@media (max-width: 600px) {
  header { padding: 1.25rem 1.5rem; }
  .hero { padding: 3rem 1.25rem 2rem; }
  .app-wrap { padding: 0 1rem 4rem; }
  .drop-zone { padding: 2rem 1rem; margin: 1.25rem; }
  .thumbs-wrap, .bottom-bar, .progress-panel, .result-panel { padding-left: 1.25rem; padding-right: 1.25rem; }
  .bottom-bar { flex-direction: column; align-items: stretch; }
  .btn-row { justify-content: flex-end; }
}
</style>
</head>
<body>

<div class="blob blob1"></div>
<div class="blob blob2"></div>
<div class="blob blob3"></div>

<header>
  <a href="#" class="logo">
    <div class="logo-icon">üñºÔ∏è</div>
    BigPicture
  </a>
  <div class="nav-pill">Free Forever</div>
</header>

<section class="hero">
  <div class="hero-eyebrow">‚ú® Photos & Videos Supported</div>
  <h1>Turn your shots into<br><span>one big panorama</span></h1>
  <p>Upload overlapping photos or a video and we'll intelligently stitch them together into a single wide image ‚Äî automatically.</p>

  <div class="format-pills">
    <span class="pill">JPG</span>
    <span class="pill">PNG</span>
    <span class="pill">WEBP</span>
    <span class="pill">HEIC</span>
    <span class="pill">RAW</span>
    <span class="pill">BMP</span>
    <span class="pill">TIFF</span>
    <span class="pill video">üé¨ MP4</span>
    <span class="pill video">üé¨ MOV</span>
    <span class="pill video">üé¨ AVI</span>
    <span class="pill video">üé¨ MKV</span>
    <span class="pill video">üé¨ + more</span>
  </div>
</section>

<div class="app-wrap">
  <div class="card">

    <!-- Mode Tabs -->
    <div class="mode-tabs">
      <button class="mode-tab active" id="tab-photos" onclick="switchMode('photos')">
        <div class="tab-icon">üñºÔ∏è</div>
        Photos
      </button>
      <button class="mode-tab" id="tab-video" onclick="switchMode('video')">
        <div class="tab-icon">üé¨</div>
        Video
      </button>
    </div>

    <!-- Photos Panel -->
    <div class="panel active" id="panel-photos">
      <div class="drop-zone" id="photoZone">
        <input type="file" id="photoInput" accept="image/*" multiple>
        <div class="drop-icon">üñºÔ∏è</div>
        <div class="drop-title">Drop your photos here</div>
        <div class="drop-sub">or click to browse ‚Äî any order, any format</div>
      </div>
    </div>

    <!-- Video Panel -->
    <div class="panel" id="panel-video">
      <div class="drop-zone" id="videoZone">
        <input type="file" id="videoInput" accept="video/*,.mp4,.mov,.avi,.mkv,.wmv,.flv,.webm,.m4v,.3gp,.mts,.m2ts">
        <div class="drop-icon">üé¨</div>
        <div class="drop-title">Drop your video here</div>
        <div class="drop-sub">MP4, MOV, AVI, MKV and more</div>
      </div>

      <div class="video-options" id="videoOptions" style="display:none">
        <label>üì∏ Extract 1 frame every <strong id="nthLabel">10</strong> frames
          <span style="font-weight:400;color:var(--muted)"> ‚Äî fewer = more frames = bigger panorama but slower</span>
        </label>
        <div class="slider-wrap">
          <input type="range" id="nthSlider" min="2" max="60" value="10" oninput="updateNth(this.value)">
          <div class="slider-val" id="sliderVal">every 10 frames</div>
        </div>
      </div>
    </div>

    <!-- Thumbnails -->
    <div class="thumbs-wrap" id="thumbsWrap">
      <div class="thumbs-label" id="thumbsLabel">Preview</div>
      <div class="thumbs-grid" id="thumbsGrid"></div>
    </div>

    <!-- Error -->
    <div class="error-box" id="errorBox">
      <span>‚ö†Ô∏è</span>
      <span id="errorText"></span>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
      <div class="file-badge" id="fileBadge">
        <span>No files selected</span>
      </div>
      <div class="btn-row">
        <button class="btn btn-ghost" id="clearBtn" onclick="clearAll()" style="display:none">Clear</button>
        <button class="btn btn-primary" id="stitchBtn" onclick="startStitch()" disabled>
          Stitch Panorama ‚ú®
        </button>
      </div>
    </div>

    <!-- Progress Panel -->
    <div class="progress-panel" id="progressPanel">
      <div class="progress-pct" id="progressPct">0%</div>
      <div class="big-progress">
        <div class="big-progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-info">
        <span id="progressStatus">Starting‚Ä¶</span>
        <span id="progressDetail"></span>
      </div>

      <div class="steps" id="stepsWrap" style="margin-top:1.5rem">
        <div class="step" id="step-session">
          <div class="step-icon">üîó</div>
          <div class="step-text">
            <div>Starting session</div>
            <div class="step-detail">Connecting to processing server</div>
          </div>
        </div>
        <div class="step" id="step-upload">
          <div class="step-icon">üì§</div>
          <div class="step-text">
            <div id="uploadStepLabel">Uploading & clustering images</div>
            <div class="step-detail" id="uploadStepDetail">Grouping similar images together</div>
          </div>
        </div>
        <div class="step" id="step-stitch">
          <div class="step-icon">üß©</div>
          <div class="step-text">
            <div>Stitching clusters</div>
            <div class="step-detail">Merging overlapping images in each group</div>
          </div>
        </div>
        <div class="step" id="step-merge">
          <div class="step-icon">üñºÔ∏è</div>
          <div class="step-text">
            <div>Final merge</div>
            <div class="step-detail">Combining all groups into one panorama</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Result Panel -->
    <div class="result-panel" id="resultPanel">
      <div class="result-header">
        <div class="result-badge">‚úÖ Ready</div>
        <div class="result-title">Your panorama is ready!</div>
      </div>
      <div class="result-img-wrap">
        <img id="resultImg" src="" alt="Panorama">
      </div>
      <div class="result-actions">
        <a id="downloadBtn" class="btn btn-primary" download="panorama.jpg">‚¨áÔ∏è Download Panorama</a>
        <button class="btn btn-ghost" onclick="clearAll()">Start over</button>
      </div>
    </div>

  </div>
</div>

<footer>
  Made with ‚ù§Ô∏è ‚Äî <a href="https://github.com/mesarpreetsingh/bigpicture" target="_blank">Open source on GitHub</a> ¬∑ All processing on server ¬∑ Images never stored permanently
</footer>

<script>
const API = 'https://singh56-bigpicture.hf.space';
const BATCH_SIZE = 10;

let mode = 'photos';
let selectedFiles = [];
let selectedVideo = null;

// ‚îÄ‚îÄ Mode switch ‚îÄ‚îÄ
function switchMode(m) {
  mode = m;
  document.getElementById('tab-photos').classList.toggle('active', m === 'photos');
  document.getElementById('tab-video').classList.toggle('active', m === 'video');
  document.getElementById('panel-photos').classList.toggle('active', m === 'photos');
  document.getElementById('panel-video').classList.toggle('active', m === 'video');
  clearAll();
}

// ‚îÄ‚îÄ Photos ‚îÄ‚îÄ
const photoZone = document.getElementById('photoZone');
const photoInput = document.getElementById('photoInput');

photoZone.addEventListener('click', () => photoInput.click());
photoZone.addEventListener('dragover', e => { e.preventDefault(); photoZone.classList.add('dragover'); });
photoZone.addEventListener('dragleave', () => photoZone.classList.remove('dragover'));
photoZone.addEventListener('drop', e => {
  e.preventDefault(); photoZone.classList.remove('dragover');
  handlePhotos([...e.dataTransfer.files].filter(f => f.type.startsWith('image/')));
});
photoInput.addEventListener('change', () => handlePhotos([...photoInput.files]));

function handlePhotos(files) {
  selectedFiles = [...selectedFiles, ...files];
  renderPhotoThumbs();
  updateUI();
}

function renderPhotoThumbs() {
  const grid = document.getElementById('thumbsGrid');
  grid.innerHTML = '';
  const max = 12;
  selectedFiles.slice(0, max).forEach((f, i) => {
    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = URL.createObjectURL(f);
    img.style.animationDelay = (i * 0.04) + 's';
    grid.appendChild(img);
  });
  if (selectedFiles.length > max) {
    const more = document.createElement('div');
    more.className = 'thumb-more';
    more.textContent = '+' + (selectedFiles.length - max);
    grid.appendChild(more);
  }
  document.getElementById('thumbsWrap').classList.toggle('visible', selectedFiles.length > 0);
  document.getElementById('thumbsLabel').textContent = `${selectedFiles.length} photo${selectedFiles.length > 1 ? 's' : ''} selected`;
}

// ‚îÄ‚îÄ Video ‚îÄ‚îÄ
const videoZone = document.getElementById('videoZone');
const videoInput = document.getElementById('videoInput');

videoZone.addEventListener('click', () => videoInput.click());
videoZone.addEventListener('dragover', e => { e.preventDefault(); videoZone.classList.add('dragover'); });
videoZone.addEventListener('dragleave', () => videoZone.classList.remove('dragover'));
videoZone.addEventListener('drop', e => {
  e.preventDefault(); videoZone.classList.remove('dragover');
  const f = e.dataTransfer.files[0];
  if (f) handleVideo(f);
});
videoInput.addEventListener('change', () => { if (videoInput.files[0]) handleVideo(videoInput.files[0]); });

function handleVideo(file) {
  selectedVideo = file;
  document.getElementById('videoOptions').style.display = 'block';
  document.getElementById('thumbsWrap').classList.add('visible');
  document.getElementById('thumbsLabel').textContent = `üé¨ ${file.name}`;
  const grid = document.getElementById('thumbsGrid');
  grid.innerHTML = '';
  // Show video thumbnail
  const vid = document.createElement('video');
  vid.src = URL.createObjectURL(file);
  vid.style.cssText = 'width:120px;height:80px;border-radius:10px;object-fit:cover;border:2px solid var(--border)';
  grid.appendChild(vid);
  updateUI();
}

// ‚îÄ‚îÄ Slider ‚îÄ‚îÄ
function updateNth(val) {
  document.getElementById('nthLabel').textContent = val;
  document.getElementById('sliderVal').textContent = `every ${val} frames`;
}

// ‚îÄ‚îÄ UI state ‚îÄ‚îÄ
function updateUI() {
  const hasFiles = mode === 'photos' ? selectedFiles.length >= 2 : selectedVideo !== null;
  const count = mode === 'photos' ? selectedFiles.length : (selectedVideo ? 1 : 0);
  const batches = Math.ceil(selectedFiles.length / BATCH_SIZE);

  document.getElementById('stitchBtn').disabled = !hasFiles;
  document.getElementById('clearBtn').style.display = count > 0 ? 'inline-flex' : 'none';

  if (mode === 'photos' && selectedFiles.length > 0) {
    document.getElementById('fileBadge').innerHTML =
      `<span class="count">${selectedFiles.length}</span> photo${selectedFiles.length > 1 ? 's' : ''} ‚Äî ${batches} smart batch${batches > 1 ? 'es' : ''}`;
  } else if (mode === 'video' && selectedVideo) {
    const mb = (selectedVideo.size / 1024 / 1024).toFixed(1);
    document.getElementById('fileBadge').innerHTML =
      `<span class="count">üé¨</span> ${selectedVideo.name} (${mb} MB)`;
  } else {
    document.getElementById('fileBadge').innerHTML = '<span>No files selected</span>';
  }
}

function clearAll() {
  selectedFiles = []; selectedVideo = null;
  photoInput.value = ''; videoInput.value = '';
  document.getElementById('thumbsWrap').classList.remove('visible');
  document.getElementById('thumbsGrid').innerHTML = '';
  document.getElementById('videoOptions').style.display = 'none';
  document.getElementById('progressPanel').classList.remove('visible');
  document.getElementById('resultPanel').classList.remove('visible');
  document.getElementById('errorBox').classList.remove('visible');
  document.getElementById('stitchBtn').innerHTML = 'Stitch Panorama ‚ú®';
  resetSteps();
  updateUI();
}

// ‚îÄ‚îÄ Steps ‚îÄ‚îÄ
const stepOrder = ['session','upload','stitch','merge'];

function setStep(id) {
  stepOrder.forEach(s => {
    const el = document.getElementById('step-' + s);
    el.classList.remove('active','done');
    if (s === id) {
      el.classList.add('active');
      el.querySelector('.step-icon').innerHTML = '<span class="spinner spin-orange"></span>';
    } else if (stepOrder.indexOf(s) < stepOrder.indexOf(id)) {
      el.classList.add('done');
      el.querySelector('.step-icon').textContent = '‚úÖ';
    } else {
      // reset icon
      const icons = {'session':'üîó','upload':'üì§','stitch':'üß©','merge':'üñºÔ∏è'};
      el.querySelector('.step-icon').textContent = icons[s];
    }
  });
}

function doneAllSteps() {
  stepOrder.forEach(s => {
    const el = document.getElementById('step-' + s);
    el.classList.remove('active'); el.classList.add('done');
    el.querySelector('.step-icon').textContent = '‚úÖ';
  });
}

function resetSteps() {
  const icons = {'session':'üîó','upload':'üì§','stitch':'üß©','merge':'üñºÔ∏è'};
  stepOrder.forEach(s => {
    const el = document.getElementById('step-' + s);
    el.classList.remove('active','done');
    el.querySelector('.step-icon').textContent = icons[s];
  });
}

function setProgress(pct, status, detail) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').textContent = Math.round(pct) + '%';
  if (status) document.getElementById('progressStatus').textContent = status;
  if (detail !== undefined) document.getElementById('progressDetail').textContent = detail;
}

// ‚îÄ‚îÄ Main stitch ‚îÄ‚îÄ
async function startStitch() {
  hideError();
  document.getElementById('resultPanel').classList.remove('visible');
  document.getElementById('progressPanel').classList.add('visible');
  document.getElementById('stitchBtn').disabled = true;
  document.getElementById('stitchBtn').innerHTML = '<span class="spinner"></span> Processing‚Ä¶';
  resetSteps();

  try {
    // 1. Start session
    setStep('session');
    setProgress(3, 'Starting session‚Ä¶', '');
    const sessRes = await fetch(`${API}/start-session`, { method: 'POST' });
    const { session_id } = await sessRes.json();

    if (mode === 'video') {
      await processVideo(session_id);
    } else {
      await processPhotos(session_id);
    }

    // Finalize
    setStep('merge');
    setProgress(82, 'Final merge‚Ä¶', 'Combining all clusters');

    const finalForm = new FormData();
    finalForm.append('session_id', session_id);
    const finalRes = await fetch(`${API}/finalize`, { method: 'POST', body: finalForm });

    const ct = finalRes.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      const err = await finalRes.json();
      throw new Error(err.error || 'Merge failed');
    }

    doneAllSteps();
    setProgress(100, 'Complete!', '');

    const blob = await finalRes.blob();
    const url = URL.createObjectURL(blob);

    setTimeout(() => {
      document.getElementById('progressPanel').classList.remove('visible');
      showResult(url);
    }, 800);

  } catch (err) {
    document.getElementById('progressPanel').classList.remove('visible');
    showError(err.message);
    document.getElementById('stitchBtn').disabled = false;
    document.getElementById('stitchBtn').innerHTML = 'Stitch Panorama ‚ú®';
  }
}

async function processPhotos(session_id) {
  const totalBatches = Math.ceil(selectedFiles.length / BATCH_SIZE);
  setStep('upload');
  document.getElementById('uploadStepLabel').textContent = 'Uploading & clustering images';

  for (let i = 0; i < totalBatches; i++) {
    const pct = 8 + ((i / totalBatches) * 60);
    setProgress(pct, `Uploading batch ${i + 1} of ${totalBatches}‚Ä¶`, `Smart clustering by visual similarity`);

    const batch = selectedFiles.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
    const form = new FormData();
    form.append('session_id', session_id);
    batch.forEach(f => form.append('files', f));

    const res = await fetch(`${API}/upload-batch`, { method: 'POST', body: form });
    const json = await res.json();
    if (json.error) throw new Error(json.error);
  }

  setStep('stitch');
  setProgress(72, 'Stitching clusters‚Ä¶', `${totalBatches} clusters processed`);
  await new Promise(r => setTimeout(r, 400));
}

async function processVideo(session_id) {
  const every_nth = parseInt(document.getElementById('nthSlider').value);
  setStep('upload');
  document.getElementById('uploadStepLabel').textContent = 'Uploading video & extracting frames';
  document.getElementById('uploadStepDetail').textContent = `Extracting 1 frame every ${every_nth} frames`;
  setProgress(10, 'Uploading video‚Ä¶', 'This may take a moment for large files');

  const form = new FormData();
  form.append('session_id', session_id);
  form.append('file', selectedVideo);
  form.append('every_nth', every_nth);

  const res = await fetch(`${API}/extract-video`, { method: 'POST', body: form });
  const json = await res.json();
  if (json.error) throw new Error(json.error);

  setStep('stitch');
  setProgress(70, 'Stitching frames‚Ä¶', `${json.extracted_frames} frames extracted into ${json.clusters} clusters`);
  await new Promise(r => setTimeout(r, 400));
}

function showResult(url) {
  document.getElementById('resultImg').src = url;
  document.getElementById('downloadBtn').href = url;
  document.getElementById('resultPanel').classList.add('visible');
  document.getElementById('stitchBtn').disabled = false;
  document.getElementById('stitchBtn').innerHTML = 'Stitch Panorama ‚ú®';
  document.getElementById('resultPanel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showError(msg) {
  document.getElementById('errorText').textContent = msg;
  document.getElementById('errorBox').classList.add('visible');
}

function hideError() {
  document.getElementById('errorBox').classList.remove('visible');
}
</script>
</body>
</html>

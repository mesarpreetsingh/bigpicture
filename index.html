<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BigPicture — Panorama Stitcher</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --white: #fafaf8;
    --cream: #f4f2ed;
    --ink: #1a1a1a;
    --muted: #888;
    --accent: #c8b89a;
    --border: #e8e4dc;
    --green: #4caf82;
  }

  html { scroll-behavior: smooth; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--white);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 999;
    opacity: 0.4;
  }

  header {
    padding: 2.5rem 4rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    animation: fadeDown 0.8s ease both;
  }

  .logo { font-family: 'DM Serif Display', serif; font-size: 1.5rem; letter-spacing: -0.02em; }
  .logo span { font-style: italic; color: var(--muted); }

  .badge {
    font-size: 0.7rem; font-weight: 500; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--muted);
    border: 1px solid var(--border); padding: 0.35rem 0.75rem; border-radius: 100px;
  }

  .hero { padding: 6rem 4rem 4rem; max-width: 900px; animation: fadeUp 0.9s 0.1s ease both; }

  .hero h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(3rem, 8vw, 6rem);
    line-height: 1.0; letter-spacing: -0.03em; margin-bottom: 1.5rem;
  }
  .hero h1 em { font-style: italic; color: var(--muted); }
  .hero p { font-size: 1.1rem; font-weight: 300; color: var(--muted); max-width: 480px; line-height: 1.7; }

  .main { padding: 2rem 4rem 6rem; animation: fadeUp 1s 0.2s ease both; }

  .card { background: var(--cream); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; }

  .upload-zone {
    padding: 4rem; text-align: center;
    border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background 0.3s;
  }
  .upload-zone:hover, .upload-zone.dragover { background: #ede8e0; }

  .upload-icon {
    width: 64px; height: 64px; margin: 0 auto 1.5rem;
    border: 1.5px solid var(--border); border-radius: 16px;
    background: var(--white); display: flex; align-items: center; justify-content: center;
    transition: transform 0.3s;
  }
  .upload-zone:hover .upload-icon { transform: translateY(-4px); }
  .upload-icon svg { width: 28px; height: 28px; stroke: var(--muted); }

  .upload-title { font-family: 'DM Serif Display', serif; font-size: 1.4rem; margin-bottom: 0.5rem; }
  .upload-sub { font-size: 0.875rem; color: var(--muted); font-weight: 300; }
  #fileInput { display: none; }

  .preview-strip { padding: 1.5rem 2rem; display: flex; gap: 0.75rem; flex-wrap: wrap; border-bottom: 1px solid var(--border); }
  .preview-strip:empty { display: none; }

  .thumb { width: 80px; height: 60px; border-radius: 8px; object-fit: cover; border: 1.5px solid var(--border); animation: popIn 0.3s ease both; }
  .thumb-count {
    width: 80px; height: 60px; border-radius: 8px;
    background: var(--white); border: 1.5px dashed var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem; color: var(--muted); font-weight: 500;
  }

  .controls { padding: 2rem 4rem; display: flex; align-items: center; justify-content: space-between; gap: 2rem; flex-wrap: wrap; }
  .file-info { font-size: 0.875rem; color: var(--muted); font-weight: 300; }
  .file-info strong { color: var(--ink); font-weight: 500; }

  .btn {
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500;
    padding: 0.85rem 2.5rem; border-radius: 100px; border: none;
    cursor: pointer; transition: all 0.25s; letter-spacing: 0.02em;
    text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem;
  }
  .btn-primary { background: var(--ink); color: var(--white); }
  .btn-primary:hover { background: #333; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
  .btn-primary:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); font-size: 0.8rem; padding: 0.6rem 1.25rem; }
  .btn-ghost:hover { border-color: var(--ink); color: var(--ink); }

  .progress-section { padding: 2rem 4rem; border-top: 1px solid var(--border); display: none; }
  .progress-section.visible { display: block; animation: fadeUp 0.4s ease both; }

  .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem; }
  .progress-status { font-size: 0.875rem; font-weight: 500; }
  .progress-pct { font-family: 'DM Serif Display', serif; font-size: 1.5rem; }

  .progress-bar { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; margin-bottom: 1.2rem; }
  .progress-fill { height: 100%; background: var(--ink); border-radius: 2px; width: 0%; transition: width 0.5s ease; position: relative; }
  .progress-fill.active::after {
    content: ''; position: absolute; right: 0; top: 0;
    height: 100%; width: 60px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6));
    animation: shimmer 1.2s infinite;
  }

  .batch-track { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 0.75rem; }
  .batch-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--border); transition: all 0.3s; }
  .batch-dot.uploading { background: var(--accent); transform: scale(1.3); }
  .batch-dot.done { background: var(--green); }
  .batch-dot.error { background: #e74c3c; }

  .stage-list { display: flex; gap: 2rem; margin-top: 1.2rem; flex-wrap: wrap; }
  .stage { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; color: var(--muted); transition: color 0.3s; }
  .stage.active { color: var(--ink); font-weight: 500; }
  .stage.done { color: var(--green); }
  .stage-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); transition: background 0.3s; }
  .stage.active .stage-dot { background: var(--ink); }
  .stage.done .stage-dot { background: var(--green); }

  .result-section { padding: 2rem 4rem 4rem; display: none; border-top: 1px solid var(--border); }
  .result-section.visible { display: block; animation: fadeUp 0.6s ease both; }

  .result-label {
    font-size: 0.75rem; font-weight: 500; letter-spacing: 0.1em;
    text-transform: uppercase; color: var(--muted); margin-bottom: 1.5rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .result-label::before { content: ''; display: inline-block; width: 6px; height: 6px; background: var(--green); border-radius: 50%; }

  .result-image-wrap {
    border-radius: 12px; overflow: hidden; border: 1px solid var(--border);
    background: var(--white); margin-bottom: 1.5rem;
    max-height: 500px; display: flex; align-items: center; justify-content: center;
  }
  .result-image-wrap img { width: 100%; object-fit: contain; display: block; max-height: 500px; }
  .result-actions { display: flex; gap: 1rem; align-items: center; }

  .error-msg {
    padding: 1rem 1.5rem; background: #fff5f5; border: 1px solid #ffd5d5;
    border-radius: 10px; color: #c0392b; font-size: 0.875rem;
    margin: 0 4rem 2rem; display: none;
  }
  .error-msg.visible { display: block; animation: fadeUp 0.4s ease both; }

  footer {
    border-top: 1px solid var(--border); padding: 2rem 4rem;
    display: flex; justify-content: space-between; align-items: center;
    font-size: 0.8rem; color: var(--muted); font-weight: 300;
  }

  .spinner {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }

  @keyframes fadeDown { from { opacity:0; transform:translateY(-12px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeUp   { from { opacity:0; transform:translateY(16px);  } to { opacity:1; transform:translateY(0); } }
  @keyframes popIn    { from { opacity:0; transform:scale(0.85); }       to { opacity:1; transform:scale(1); } }
  @keyframes spin     { to { transform: rotate(360deg); } }
  @keyframes shimmer  { from { opacity:0; } 50% { opacity:1; } to { opacity:0; } }

  @media (max-width: 640px) {
    header, .hero, .main { padding-left: 1.5rem; padding-right: 1.5rem; }
    .controls, .result-section, .progress-section, .error-msg { padding-left: 1.5rem; padding-right: 1.5rem; }
    .upload-zone { padding: 2.5rem 1.5rem; }
    footer { padding: 1.5rem; flex-direction: column; gap: 0.5rem; text-align: center; }
    .hero h1 { font-size: 2.5rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Big<span>Picture</span></div>
  <div class="badge">Panorama Stitcher</div>
</header>

<section class="hero">
  <h1>Stitch any<br>scene into<br><em>one frame.</em></h1>
  <p>Upload hundreds of overlapping photos and we'll automatically combine them into one wide panorama — processed in smart batches.</p>
</section>

<section class="main">
  <div class="card">

    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept="image/*" multiple>
      <div class="upload-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </div>
      <div class="upload-title">Drop your photos here</div>
      <div class="upload-sub">or click to browse — supports hundreds of overlapping images</div>
    </div>

    <div class="preview-strip" id="previewStrip"></div>

    <div class="controls">
      <div class="file-info" id="fileInfo">No images selected</div>
      <div style="display:flex;gap:0.75rem;align-items:center">
        <button class="btn btn-ghost" id="clearBtn" onclick="clearAll()" style="display:none">Clear</button>
        <button class="btn btn-primary" id="stitchBtn" onclick="startStitch()" disabled>Stitch Panorama</button>
      </div>
    </div>

    <div class="progress-section" id="progressSection">
      <div class="progress-header">
        <div class="progress-status" id="progressStatus">Starting…</div>
        <div class="progress-pct" id="progressPct">0%</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill active" id="progressFill"></div>
      </div>
      <div class="batch-track" id="batchTrack"></div>
      <div class="stage-list">
        <div class="stage" id="stage-upload"><span class="stage-dot"></span>Uploading batches</div>
        <div class="stage" id="stage-stitch"><span class="stage-dot"></span>Stitching</div>
        <div class="stage" id="stage-merge"><span class="stage-dot"></span>Merging</div>
        <div class="stage" id="stage-done"><span class="stage-dot"></span>Done</div>
      </div>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <div class="result-section" id="resultSection">
      <div class="result-label">Panorama ready</div>
      <div class="result-image-wrap">
        <img id="resultImg" src="" alt="Panorama result">
      </div>
      <div class="result-actions">
        <a id="downloadBtn" class="btn btn-primary" download="panorama.jpg">Download Image</a>
        <button class="btn btn-ghost" onclick="clearAll()">Start over</button>
      </div>
    </div>

  </div>
</section>

<footer>
  <span>BigPicture — images processed on server, never stored permanently.</span>
  <span>Free &amp; open source</span>
</footer>

<script>
  const API = 'https://singh56-bigpicture.hf.space';
  const BATCH_SIZE = 10;

  let selectedFiles = [];

  const zone = document.getElementById('uploadZone');
  const input = document.getElementById('fileInput');

  zone.addEventListener('click', () => input.click());
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('dragover');
    handleFiles([...e.dataTransfer.files].filter(f => f.type.startsWith('image/')));
  });
  input.addEventListener('change', () => handleFiles([...input.files]));

  function handleFiles(files) {
    selectedFiles = [...selectedFiles, ...files];
    renderPreviews();
    updateUI();
  }

  function renderPreviews() {
    const strip = document.getElementById('previewStrip');
    strip.innerHTML = '';
    const max = 10;
    selectedFiles.slice(0, max).forEach(f => {
      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = URL.createObjectURL(f);
      strip.appendChild(img);
    });
    if (selectedFiles.length > max) {
      const extra = document.createElement('div');
      extra.className = 'thumb-count';
      extra.textContent = `+${selectedFiles.length - max} more`;
      strip.appendChild(extra);
    }
  }

  function updateUI() {
    const n = selectedFiles.length;
    const batches = Math.ceil(n / BATCH_SIZE);
    document.getElementById('fileInfo').innerHTML = n === 0
      ? 'No images selected'
      : `<strong>${n} image${n > 1 ? 's' : ''}</strong> — will process in ${batches} batch${batches > 1 ? 'es' : ''} of ${BATCH_SIZE}`;
    document.getElementById('stitchBtn').disabled = n < 2;
    document.getElementById('clearBtn').style.display = n > 0 ? 'inline-flex' : 'none';
  }

  function clearAll() {
    selectedFiles = [];
    document.getElementById('previewStrip').innerHTML = '';
    document.getElementById('resultSection').classList.remove('visible');
    document.getElementById('errorMsg').classList.remove('visible');
    document.getElementById('progressSection').classList.remove('visible');
    document.getElementById('fileInput').value = '';
    resetStages();
    updateUI();
  }

  const stageOrder = ['upload','stitch','merge','done'];

  function setStage(id) {
    stageOrder.forEach(s => {
      const el = document.getElementById('stage-' + s);
      el.classList.remove('active', 'done');
      if (s === id) el.classList.add('active');
      else if (stageOrder.indexOf(s) < stageOrder.indexOf(id)) el.classList.add('done');
    });
  }

  function resetStages() {
    stageOrder.forEach(s => document.getElementById('stage-' + s).classList.remove('active','done'));
  }

  function setProgress(pct, status) {
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressPct').textContent = Math.round(pct) + '%';
    if (status) document.getElementById('progressStatus').textContent = status;
  }

  function buildBatchDots(total) {
    const track = document.getElementById('batchTrack');
    track.innerHTML = '';
    // cap visual dots at 100 to avoid overflow
    const shown = Math.min(total, 100);
    for (let i = 0; i < shown; i++) {
      const dot = document.createElement('div');
      dot.className = 'batch-dot';
      dot.id = 'dot-' + i;
      track.appendChild(dot);
    }
  }

  function dotState(i, state) {
    const dot = document.getElementById('dot-' + i);
    if (dot) dot.className = 'batch-dot ' + state;
  }

  async function startStitch() {
    hideError();
    document.getElementById('resultSection').classList.remove('visible');
    document.getElementById('progressSection').classList.add('visible');
    document.getElementById('stitchBtn').disabled = true;
    document.getElementById('stitchBtn').innerHTML = '<span class="spinner"></span> Processing…';

    const totalBatches = Math.ceil(selectedFiles.length / BATCH_SIZE);
    buildBatchDots(totalBatches);
    setStage('upload');
    setProgress(2, 'Starting session…');

    try {
      // 1. Start session
      const sessionRes = await fetch(`${API}/start-session`, { method: 'POST' });
      const { session_id } = await sessionRes.json();

      // 2. Upload batches one by one
      for (let i = 0; i < totalBatches; i++) {
        dotState(i, 'uploading');
        const batch = selectedFiles.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
        const pct = 5 + ((i / totalBatches) * 65);
        setProgress(pct, `Uploading batch ${i + 1} of ${totalBatches}…`);
        setStage('upload');

        const form = new FormData();
        form.append('session_id', session_id);
        batch.forEach(f => form.append('files', f));

        const res = await fetch(`${API}/upload-batch`, { method: 'POST', body: form });
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        dotState(i, 'done');
      }

      // 3. Finalize
      setStage('merge');
      setProgress(78, 'Merging all batches into final panorama…');

      const finalForm = new FormData();
      finalForm.append('session_id', session_id);
      const finalRes = await fetch(`${API}/finalize`, { method: 'POST', body: finalForm });

      const contentType = finalRes.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        const err = await finalRes.json();
        throw new Error(err.error || 'Merge failed');
      }

      setStage('done');
      setProgress(100, 'Complete!');

      const blob = await finalRes.blob();
      const url = URL.createObjectURL(blob);

      setTimeout(() => {
        document.getElementById('progressSection').classList.remove('visible');
        showResult(url);
      }, 800);

    } catch (err) {
      document.getElementById('progressSection').classList.remove('visible');
      showError(err.message);
      document.getElementById('stitchBtn').disabled = false;
      document.getElementById('stitchBtn').innerHTML = 'Stitch Panorama';
    }
  }

  function showResult(url) {
    document.getElementById('resultImg').src = url;
    document.getElementById('downloadBtn').href = url;
    document.getElementById('resultSection').classList.add('visible');
    document.getElementById('stitchBtn').disabled = false;
    document.getElementById('stitchBtn').innerHTML = 'Stitch Panorama';
    document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = '⚠️ ' + msg;
    el.classList.add('visible');
  }

  function hideError() {
    document.getElementById('errorMsg').classList.remove('visible');
  }
</script>
</body>
</html>

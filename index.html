<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BigPicture â€” Panorama Stitcher</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#f9f9f7;--white:#fff;--ink:#111110;--ink2:#3d3d3a;--muted:#8f8f8c;--border:#e8e8e4;--border2:#d4d4cf;--green:#16a34a;--green-bg:#f0fdf4;--green-border:#bbf7d0;--red:#dc2626;--red-bg:#fef2f2;--red-border:#fecaca;--blue:#2563eb;--blue-bg:#eff6ff;--blue-border:#bfdbfe;--amber:#d97706;--amber-bg:#fffbeb;--amber-border:#fde68a;--radius:16px;--radius-sm:10px}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;-webkit-font-smoothing:antialiased}
header{background:var(--white);border-bottom:1px solid var(--border);padding:0 3rem;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;animation:fadeDown 0.5s ease both}
.logo{display:flex;align-items:center;gap:.6rem;font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--ink);text-decoration:none;font-weight:700}
.logo-mark{width:32px;height:32px;background:var(--ink);border-radius:8px;display:flex;align-items:center;justify-content:center}
.logo-mark svg{width:18px;height:18px;stroke:white;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.header-tag{font-size:.72rem;font-weight:500;letter-spacing:.06em;text-transform:uppercase;color:var(--muted)}
.page{max-width:1100px;margin:0 auto;padding:3.5rem 2rem 6rem;display:grid;grid-template-columns:1fr 380px;gap:2rem;align-items:start}
.left{animation:fadeUp 0.6s 0.1s ease both}
.page-title{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:700;line-height:1.15;letter-spacing:-.02em;margin-bottom:.75rem}
.page-title em{font-style:italic;font-weight:400;color:var(--muted)}
.page-sub{font-size:.95rem;color:var(--muted);line-height:1.7;max-width:440px;margin-bottom:2.5rem}
.wake-banner{display:none;align-items:center;gap:.75rem;background:var(--amber-bg);border:1px solid var(--amber-border);border-radius:var(--radius-sm);padding:.875rem 1.25rem;margin-bottom:1.25rem;font-size:.82rem;color:var(--amber);font-weight:500}
.wake-banner.visible{display:flex;animation:fadeUp 0.3s ease both}
.wake-dots span{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--amber);margin:0 2px;animation:wakeDot 1.2s infinite}
.wake-dots span:nth-child(2){animation-delay:.2s}
.wake-dots span:nth-child(3){animation-delay:.4s}
.upload-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:1.5rem}
.drop-zone{padding:3.5rem 2.5rem;text-align:center;cursor:pointer;transition:background .2s;border-bottom:1px solid var(--border)}
.drop-zone:hover,.drop-zone.dragover{background:var(--bg)}
.drop-zone input{display:none}
.drop-icon-wrap{width:56px;height:56px;margin:0 auto 1.2rem;background:var(--bg);border:1px solid var(--border2);border-radius:14px;display:flex;align-items:center;justify-content:center;transition:transform .25s,box-shadow .25s}
.drop-zone:hover .drop-icon-wrap{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.08)}
.drop-icon-wrap svg{width:24px;height:24px;stroke:var(--ink2);fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.drop-title{font-size:1rem;font-weight:600;color:var(--ink);margin-bottom:.3rem}
.drop-sub{font-size:.82rem;color:var(--muted)}
.drop-formats{display:flex;justify-content:center;gap:.4rem;flex-wrap:wrap;margin-top:1rem}
.fmt{font-size:.68rem;font-weight:600;letter-spacing:.04em;color:var(--muted);background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.2rem .45rem}
.thumbs-section{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:none}
.thumbs-section.visible{display:block}
.thumbs-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.875rem}
.thumbs-label{font-size:.75rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--muted)}
.thumbs-count{font-size:.78rem;font-weight:600;color:var(--ink2);background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:.15rem .6rem}
.thumbs-grid{display:flex;gap:.5rem;flex-wrap:wrap}
.thumb{width:68px;height:52px;border-radius:7px;object-fit:cover;border:1px solid var(--border);animation:popIn .25s ease both}
.thumb-overflow{width:68px;height:52px;border-radius:7px;background:var(--bg);border:1px dashed var(--border2);display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:600;color:var(--muted)}
.card-footer{padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.file-info{font-size:.82rem;color:var(--muted)}
.file-info strong{color:var(--ink);font-weight:600}
.btn-row{display:flex;gap:.6rem;align-items:center}
.btn{font-family:'Inter',sans-serif;font-size:.85rem;font-weight:600;padding:.65rem 1.5rem;border-radius:8px;border:none;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.35rem;text-decoration:none;line-height:1}
.btn-primary{background:var(--ink);color:white}
.btn-primary:hover:not(:disabled){background:#2d2d2d;transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.2)}
.btn-primary:disabled{background:var(--border);color:var(--muted);cursor:not-allowed;transform:none;box-shadow:none}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);font-size:.8rem;padding:.6rem 1.1rem}
.btn-ghost:hover{border-color:var(--border2);color:var(--ink2)}
.btn-debug{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border);font-size:.8rem;padding:.6rem 1.1rem;cursor:pointer}
.btn-debug:hover{background:#dbeafe}
.right{animation:fadeUp 0.6s 0.2s ease both}
.progress-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:none;margin-bottom:1.5rem}
.progress-card.visible{display:block;animation:fadeUp .4s ease both}
.progress-card-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.progress-card-title{font-size:.85rem;font-weight:600}
.pct-badge{font-size:1.1rem;font-weight:600;font-family:'Playfair Display',serif}
.progress-bar-wrap{padding:1.25rem 1.5rem}
.progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:.5rem}
.progress-bar-fill{height:100%;background:var(--ink);border-radius:2px;width:0%;transition:width .6s cubic-bezier(.4,0,.2,1);position:relative}
.progress-bar-fill::after{content:'';position:absolute;right:0;top:0;width:50px;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5));animation:shimmer 1.5s infinite}
.progress-status{font-size:.75rem;color:var(--muted)}
.steps{padding:0 1.5rem 1.5rem;display:flex;flex-direction:column;gap:.4rem}
.step{display:flex;align-items:center;gap:.875rem;padding:.75rem 1rem;border-radius:var(--radius-sm);border:1px solid transparent;transition:all .3s}
.step.active{background:var(--bg);border-color:var(--border)}
.step-dot{width:24px;height:24px;border-radius:50%;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .3s}
.step.active .step-dot{border-color:var(--ink);background:var(--ink)}
.step.done .step-dot{border-color:var(--green);background:var(--green)}
.step-label{font-size:.82rem;font-weight:500;color:var(--muted);transition:color .3s}
.step.active .step-label{color:var(--ink);font-weight:600}
.step.done .step-label{color:var(--green)}
.step-sublabel{font-size:.72rem;color:var(--muted);margin-top:.1rem}
.debug-panel{background:#0f0f0f;border:1px solid #333;border-radius:var(--radius);padding:1.25rem;margin-bottom:1.5rem;display:none;font-family:'Courier New',monospace}
.debug-panel.visible{display:block;animation:fadeUp .4s ease both}
.debug-title{font-size:.75rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:#888;margin-bottom:1rem}
.debug-row{display:flex;justify-content:space-between;padding:.35rem 0;border-bottom:1px solid #222;font-size:.75rem}
.debug-row:last-child{border-bottom:none}
.debug-key{color:#888}
.debug-val{color:#4ade80;font-weight:600}
.debug-val.bad{color:#f87171}
.debug-val.warn{color:#fbbf24}
.debug-section{margin-top:.75rem;padding-top:.75rem;border-top:1px solid #222}
.debug-section-title{font-size:.7rem;color:#666;letter-spacing:.06em;text-transform:uppercase;margin-bottom:.5rem}
.debug-attempt{padding:.4rem .6rem;border-radius:6px;font-size:.72rem;margin-bottom:.3rem}
.debug-attempt.success{background:#052e16;color:#4ade80}
.debug-attempt.failed{background:#1f0808;color:#f87171}
.debug-attempt.warn{background:#1c1600;color:#fbbf24}
.result-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:none;margin-bottom:1.5rem}
.result-card.visible{display:block;animation:fadeUp .5s ease both}
.result-card-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem}
.result-badge{display:inline-flex;align-items:center;gap:.35rem;background:var(--green-bg);border:1px solid var(--green-border);border-radius:100px;padding:.25rem .65rem;font-size:.72rem;font-weight:600;color:var(--green)}
.result-card-title{font-size:.85rem;font-weight:600}
.result-img-wrap{background:var(--bg);display:flex;align-items:center;justify-content:center;max-height:320px;overflow:hidden;border-bottom:1px solid var(--border)}
.result-img-wrap img{width:100%;object-fit:contain;max-height:320px;display:block}
.result-actions{padding:1rem 1.5rem;display:flex;gap:.6rem;flex-wrap:wrap}
.error-box{margin:0 1.5rem 1.25rem;padding:.875rem 1rem;background:var(--red-bg);border:1px solid var(--red-border);border-radius:var(--radius-sm);font-size:.82rem;font-weight:500;color:var(--red);display:none}
.error-box.visible{display:flex;align-items:flex-start;gap:.5rem}
.info-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem}
.info-card-title{font-size:.75rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;color:var(--muted);margin-bottom:1rem}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:.6rem 0;border-bottom:1px solid var(--border);font-size:.82rem}
.info-row:last-child{border-bottom:none;padding-bottom:0}
.info-key{color:var(--muted)}
.info-val{color:var(--ink);font-weight:600}
.info-val.green{color:var(--green)}
.spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
.spinner-dark{border-color:rgba(0,0,0,.1);border-top-color:var(--ink)}
footer{text-align:center;padding:2rem;font-size:.78rem;color:var(--muted);border-top:1px solid var(--border);background:var(--white)}
footer a{color:var(--ink2);text-decoration:none;font-weight:500}
@keyframes fadeDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes popIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{from{opacity:0}50%{opacity:1}to{opacity:0}}
@keyframes wakeDot{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
@media(max-width:820px){.page{grid-template-columns:1fr}.right{order:-1}header{padding:0 1.5rem}.page{padding:2rem 1.25rem 4rem}}
</style>
</head>
<body>
<header>
  <a href="#" class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="18" height="7" rx="1"/></svg>
    </div>
    BigPicture
  </a>
  <div class="header-tag">Free &middot; No account needed</div>
</header>

<div class="page">
  <div class="left">
    <h1 class="page-title">Stitch photos into<br><em>one panorama.</em></h1>
    <p class="page-sub">Upload overlapping images in any order &mdash; BigPicture automatically figures out the layout and stitches them into one image.</p>
    <div class="wake-banner" id="wakeBanner">
      <div class="wake-dots"><span></span><span></span><span></span></div>
      <span id="wakeMsg">Waking up server &mdash; this takes about 30 seconds on first use&hellip;</span>
    </div>
    <div class="upload-card">
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept="image/*" multiple>
        <div class="drop-icon-wrap">
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="drop-title">Drop photos here or click to browse</div>
        <div class="drop-sub">Upload overlapping images in any order</div>
        <div class="drop-formats">
          <span class="fmt">JPG</span><span class="fmt">PNG</span><span class="fmt">WEBP</span><span class="fmt">HEIC</span><span class="fmt">RAW</span><span class="fmt">TIFF</span><span class="fmt">BMP</span>
        </div>
      </div>
      <div class="thumbs-section" id="thumbsSection">
        <div class="thumbs-header">
          <span class="thumbs-label">Selected photos</span>
          <span class="thumbs-count" id="thumbsCount">0</span>
        </div>
        <div class="thumbs-grid" id="thumbsGrid"></div>
      </div>
      <div class="error-box" id="errorBox"><span>&#9888;</span><span id="errorText"></span></div>
      <div class="card-footer">
        <div class="file-info" id="fileInfo">No photos selected</div>
        <div class="btn-row">
          <button class="btn btn-ghost" id="clearBtn" onclick="clearAll()" style="display:none">Clear</button>
          <button class="btn btn-debug" id="debugBtn" onclick="runDebug()" style="display:none">&#128269; Diagnose</button>
          <button class="btn btn-primary" id="stitchBtn" onclick="startStitch()" disabled>Stitch Panorama</button>
        </div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="progress-card" id="progressCard">
      <div class="progress-card-header">
        <span class="progress-card-title" id="progressTitle">Processing</span>
        <span class="pct-badge" id="pctBadge">0%</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div>
        <div class="progress-status" id="progressStatus">Starting&hellip;</div>
      </div>
      <div class="steps">
        <div class="step" id="step-wake"><div class="step-dot"></div><div><div class="step-label">Wake server</div><div class="step-sublabel">Cold start ~30 seconds</div></div></div>
        <div class="step" id="step-session"><div class="step-dot"></div><div><div class="step-label">Start session</div><div class="step-sublabel">Connect to server</div></div></div>
        <div class="step" id="step-upload"><div class="step-dot"></div><div><div class="step-label" id="uploadLabel">Upload images</div><div class="step-sublabel">Sending to server</div></div></div>
        <div class="step" id="step-stitch"><div class="step-dot"></div><div><div class="step-label">Stitching</div><div class="step-sublabel">Finding overlaps &amp; merging</div></div></div>
        <div class="step" id="step-done"><div class="step-dot"></div><div><div class="step-label">Complete</div><div class="step-sublabel">Encoding final image</div></div></div>
      </div>
    </div>

    <div class="debug-panel" id="debugPanel">
      <div class="debug-title">&#128269; Diagnostic Report</div>
      <div id="debugContent"></div>
    </div>

    <div class="result-card" id="resultCard">
      <div class="result-card-header">
        <div class="result-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Ready</div>
        <span class="result-card-title">Panorama complete</span>
      </div>
      <div class="result-img-wrap"><img id="resultImg" src="" alt="Panorama"></div>
      <div class="result-actions">
        <a id="downloadBtn" class="btn btn-primary" download="panorama.jpg">Download</a>
        <button class="btn btn-ghost" onclick="clearAll()">Start over</button>
      </div>
    </div>

    <div class="info-card">
      <div class="info-card-title">How it works</div>
      <div class="info-row"><span class="info-key">Layout detection</span><span class="info-val green">Automatic</span></div>
      <div class="info-row"><span class="info-key">Image order</span><span class="info-val green">Any order</span></div>
      <div class="info-row"><span class="info-key">Blending</span><span class="info-val green">Multiband</span></div>
      <div class="info-row"><span class="info-key">Storage</span><span class="info-val green">Never saved</span></div>
      <div class="info-row"><span class="info-key">Cost</span><span class="info-val green">Free</span></div>
    </div>
  </div>
</div>

<footer>BigPicture &mdash; <a href="https://github.com/mesarpreetsingh/bigpicture" target="_blank">Open source</a> &middot; Images processed on server and immediately discarded</footer>

<script>
var API='https://singh56-bigpicture.hf.space';
var BATCH=10;
var files=[];
var awake=false;
var CHK='<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
var SPN='<span class="spinner spinner-dark" style="width:10px;height:10px;border-width:2px"></span>';
var STEPS=['wake','session','upload','stitch','done'];

var zone=document.getElementById('dropZone');
var inp=document.getElementById('fileInput');
zone.addEventListener('click',function(){inp.click();});
zone.addEventListener('dragover',function(e){e.preventDefault();zone.classList.add('dragover');});
zone.addEventListener('dragleave',function(){zone.classList.remove('dragover');});
zone.addEventListener('drop',function(e){e.preventDefault();zone.classList.remove('dragover');addFiles(Array.from(e.dataTransfer.files).filter(function(f){return f.type.startsWith('image/');}));});
inp.addEventListener('change',function(){addFiles(Array.from(inp.files));});

function addFiles(f){files=files.concat(f);renderThumbs();updateUI();}

function renderThumbs(){
  var g=document.getElementById('thumbsGrid');g.innerHTML='';
  files.slice(0,14).forEach(function(f,i){var im=document.createElement('img');im.className='thumb';im.src=URL.createObjectURL(f);im.style.animationDelay=(i*.03)+'s';g.appendChild(im);});
  if(files.length>14){var ov=document.createElement('div');ov.className='thumb-overflow';ov.textContent='+'+(files.length-14);g.appendChild(ov);}
  document.getElementById('thumbsSection').classList.toggle('visible',files.length>0);
  document.getElementById('thumbsCount').textContent=files.length;
}

function updateUI(){
  var n=files.length,b=Math.ceil(n/BATCH);
  document.getElementById('stitchBtn').disabled=n<2;
  document.getElementById('clearBtn').style.display=n>0?'':'none';
  var db=document.getElementById('debugBtn');
  db.style.display=n>=2?'':'none';
  db.removeAttribute('disabled');
  document.getElementById('fileInfo').innerHTML=n===0?'No photos selected':'<strong>'+n+' photo'+(n>1?'s':'')+'</strong> &middot; '+b+' batch'+(b>1?'es':'');
}

function clearAll(){
  files=[];inp.value='';
  ['thumbsSection','progressCard','resultCard','debugPanel','errorBox','wakeBanner'].forEach(function(id){document.getElementById(id).classList.remove('visible');});
  document.getElementById('thumbsGrid').innerHTML='';
  document.getElementById('stitchBtn').innerHTML='Stitch Panorama';
  resetSteps();updateUI();
}

function setStep(id){
  STEPS.forEach(function(s){
    var el=document.getElementById('step-'+s);if(!el)return;
    el.classList.remove('active','done');
    var dot=el.querySelector('.step-dot');
    if(s===id){el.classList.add('active');dot.innerHTML=SPN;}
    else if(STEPS.indexOf(s)<STEPS.indexOf(id)){el.classList.add('done');dot.innerHTML=CHK;}
    else{dot.innerHTML='';}
  });
}
function doneAll(){STEPS.forEach(function(s){var el=document.getElementById('step-'+s);if(!el)return;el.classList.remove('active');el.classList.add('done');el.querySelector('.step-dot').innerHTML=CHK;});}
function resetSteps(){STEPS.forEach(function(s){var el=document.getElementById('step-'+s);if(!el)return;el.classList.remove('active','done');el.querySelector('.step-dot').innerHTML='';});}
function setProgress(pct,msg){document.getElementById('progressFill').style.width=pct+'%';document.getElementById('pctBadge').textContent=Math.round(pct)+'%';if(msg)document.getElementById('progressStatus').textContent=msg;}

async function wakeServer(){
  if(awake)return;
  document.getElementById('wakeBanner').classList.add('visible');
  document.getElementById('progressCard').classList.add('visible');
  setStep('wake');setProgress(5,'Waking up server...');
  for(var i=0;i<20;i++){
    try{
      var r=await fetch(API+'/',{signal:AbortSignal.timeout(15000)});
      if(r.ok){
        var t=await r.text();
        try{JSON.parse(t);awake=true;document.getElementById('wakeBanner').classList.remove('visible');return;}catch(e){}
      }
    }catch(e){}
    document.getElementById('wakeMsg').textContent='Waking up server... attempt '+(i+1)+' of 20';
    setProgress(5+(i/20)*10,'Waking server... attempt '+(i+1));
    await new Promise(function(r){setTimeout(r,4000);});
  }
  document.getElementById('wakeBanner').classList.remove('visible');
  throw new Error('Server took too long to wake up. Please wait 1 minute and try again.');
}

async function safeJSON(res){
  var t=await res.text();
  try{return{ok:true,data:JSON.parse(t)};}
  catch(e){return{ok:false,error:'Server returned unexpected response. Please try again.'};}
}

async function uploadImages(){
  await wakeServer();
  setStep('session');setProgress(18,'Starting session...');
  var r=await fetch(API+'/start-session',{method:'POST'});
  var p=await safeJSON(r);
  if(!p.ok)throw new Error(p.error);
  if(p.data.error)throw new Error(p.data.error);
  var sid=p.data.session_id;
  var total=Math.ceil(files.length/BATCH);
  setStep('upload');
  for(var i=0;i<total;i++){
    setProgress(22+(i/total)*45,'Uploading batch '+(i+1)+' of '+total+'...');
    document.getElementById('uploadLabel').textContent='Uploading batch '+(i+1)+' of '+total;
    var batch=files.slice(i*BATCH,(i+1)*BATCH);
    var form=new FormData();form.append('session_id',sid);
    batch.forEach(function(f){form.append('files',f);});
    var br=await fetch(API+'/upload-batch',{method:'POST',body:form});
    var bp=await safeJSON(br);
    if(!bp.ok)throw new Error(bp.error);
    if(bp.data.error)throw new Error(bp.data.error);
  }
  return sid;
}

async function runDebug(){
  hideError();
  document.getElementById('debugPanel').classList.remove('visible');
  document.getElementById('progressCard').classList.add('visible');
  document.getElementById('progressTitle').textContent='Diagnosing';
  resetSteps();
  try{
    var sid=await uploadImages();
    setProgress(72,'Running diagnostics...');
    var form=new FormData();form.append('session_id',sid);
    var r=await fetch(API+'/debug',{method:'POST',body:form});
    var p=await safeJSON(r);
    document.getElementById('progressCard').classList.remove('visible');
    if(!p.ok)throw new Error(p.error);
    showDebug(p.data);
  }catch(e){document.getElementById('progressCard').classList.remove('visible');showError(e.message);}
  document.getElementById('progressTitle').textContent='Processing';
  resetSteps();
}

function showDebug(d){
  document.getElementById('debugPanel').classList.add('visible');
  var kp=d.avg_keypoints||0,pairs=d.total_pairs_matched||0,n=d.total_images||0,max=n*(n-1);
  var h='<div class="debug-row"><span class="debug-key">Total images</span><span class="debug-val">'+n+'</span></div>'+
    '<div class="debug-row"><span class="debug-key">Avg keypoints/image</span><span class="debug-val '+(kp<20?'bad':kp<100?'warn':'')+'">'+kp+'</span></div>'+
    '<div class="debug-row"><span class="debug-key">Matched pairs</span><span class="debug-val '+(pairs===0?'bad':pairs<3?'warn':'')+'">'+pairs+' / '+max+'</span></div>';
  if(d.feature_detection_error)h+='<div class="debug-row"><span class="debug-key">Error</span><span class="debug-val bad">'+d.feature_detection_error+'</span></div>';
  if(d.attempts&&d.attempts.length){
    h+='<div class="debug-section"><div class="debug-section-title">Stitch attempts</div>';
    d.attempts.forEach(function(a){var c=a.result==='SUCCESS'?'success':a.result==='EMPTY RESULT'?'warn':'failed';h+='<div class="debug-attempt '+c+'">conf='+a.confidence+' &rarr; '+a.result+(a.size?' ('+a.size+')':'')+(a.error?': '+a.error:'')+'</div>';});
    h+='</div>';
  }
  h+='<div class="debug-section"><div class="debug-section-title">Diagnosis</div>';
  if(kp<20)h+='<div class="debug-attempt failed">Very few keypoints &mdash; images may be blurry.</div>';
  if(pairs===0)h+='<div class="debug-attempt failed">No matching pairs &mdash; images may not overlap.</div>';
  else if(pairs<3)h+='<div class="debug-attempt warn">Very few pairs &mdash; try more overlap between images.</div>';
  else h+='<div class="debug-attempt success">Feature matching looks good &mdash; '+pairs+' pairs found.</div>';
  var ok=d.attempts&&d.attempts.find(function(a){return a.result==='SUCCESS';});
  h+=ok?'<div class="debug-attempt success">Stitching works! Click Stitch Panorama.</div>':'<div class="debug-attempt failed">All attempts failed. Paste this report so we can fix it.</div>';
  h+='</div>';
  document.getElementById('debugContent').innerHTML=h;
}

async function startStitch(){
  hideError();
  document.getElementById('resultCard').classList.remove('visible');
  document.getElementById('debugPanel').classList.remove('visible');
  document.getElementById('progressCard').classList.add('visible');
  document.getElementById('progressTitle').textContent='Processing';
  document.getElementById('stitchBtn').disabled=true;
  document.getElementById('stitchBtn').innerHTML='<span class="spinner"></span> Processing&hellip;';
  resetSteps();
  try{
    var sid=await uploadImages();
    setStep('stitch');setProgress(70,'Stitching images...');
    var form=new FormData();form.append('session_id',sid);
    var fr=await fetch(API+'/finalize',{method:'POST',body:form});
    var ct=fr.headers.get('content-type')||'';
    if(ct.indexOf('application/json')!==-1||!fr.ok){
      var p=await safeJSON(fr);
      throw new Error(p.ok?(p.data.error||'Stitching failed'):p.error);
    }
    setStep('done');setProgress(100,'Complete');doneAll();
    var blob=await fr.blob();
    if(blob.size<500)throw new Error('Server returned empty image. Try the Diagnose button.');
    var url=URL.createObjectURL(blob);
    setTimeout(function(){document.getElementById('progressCard').classList.remove('visible');showResult(url);},700);
  }catch(e){
    document.getElementById('progressCard').classList.remove('visible');
    showError(e.message);
    document.getElementById('stitchBtn').disabled=false;
    document.getElementById('stitchBtn').innerHTML='Stitch Panorama';
    resetSteps();
  }
}

function showResult(url){
  document.getElementById('resultImg').src=url;
  document.getElementById('downloadBtn').href=url;
  document.getElementById('resultCard').classList.add('visible');
  document.getElementById('stitchBtn').disabled=false;
  document.getElementById('stitchBtn').innerHTML='Stitch Panorama';
  document.getElementById('resultCard').scrollIntoView({behavior:'smooth',block:'nearest'});
}
function showError(msg){document.getElementById('errorText').textContent=msg;document.getElementById('errorBox').classList.add('visible');}
function hideError(){document.getElementById('errorBox').classList.remove('visible');}
</script>
</body>
</html>
